# 第4章 架构



> 本章学习路线图
>
> - 听听SaaSOvation的CIO是如何做项目回顾的
> - 学习使用依赖注入原则（DIP）和六边形（Hexagonal）架构来改进分层架构（Layer Architecture）
> - 学习六边形架构对SOA和REST的支
> - 学习数据网织（DataFabric）或基于网格的分布式缓存（Grid-Based Distributed Cache）和事件驱动风格
> - 学习DDD世界的新架构模式——CQRS
> - 学习SaaSOvation所才用的架构



DDD的一大好处便是它并不需要使用特定的架构。由于核心域位于界限上下文中，我们可以在整个系统中使用多种风格的结构。质量驱动的架构选择是种风险驱动方式，即我们采用的架构是减少失败风险的，而不是增加失败风险的。



## 采访一个成功的CIO

> 访谈过程略，摘抄几句对话要点

- 随着软件复杂性的增加，我们需要引入**单元测试**和**功能测试**来保证软件质量。
- 采用**聚合模式**和**资源库**，在开发时可以采用内存持久化，因为使用了相同的资源库接口，之后又可以方便地切换到其他持久化机制。
- 有些功能需要一系列分布式处理，为了不让用户久等，引入了一套完整的**事件驱动架构**，使用管道和过滤器来完成该功能。
- 某些要求需要跟踪对系统的每一次改变，解决这个事情最好的方式便是**事件源**。



## 分层

在分层架构中，我们将领域模型和业务逻辑分离出来，并减少对特定基础设施、用户界面甚至应用层逻辑的依赖，因为他们不属于业务逻辑。将一个复杂的系统分为不同的层，每层都应该具有良好的内聚性，并且只依赖于比其自身更低的层。

如图所示为一个典型的DDD传统分层结构，其中核心域只位于架构中的其中一层，上面是用户界面层和应用层，下面是基础设施层。

![DDD所使用的传统分层架构](实现领域驱动设计04.assets/DDD所使用的传统分层架构.png)



分层架构的一个重要原则是：每层只能与位于其下方的层发生耦合。用户界面只用于处理用户显示和用户请求，它不应该包含领域或业务逻辑。（其他特殊情况可以灵活，但原则不变）

当领域模型用于发布**领域事件**时，应用层可以将订阅方注册到任意数量的事件上，这样的好处是可以对事件进行存储和转发；同时领域模型只需要关注自己的核心逻辑；**领域事件发布器**可以保持轻量化而不依赖消息机制的基础设施。

有时，领域层多少需要使用到基础设施层，比如持久化机制。遵从分层架构原则并不意味领域对象要与基础设施层发生直接耦合，此时我们可以才用**模块**的方式来因层细节。

> `com.saasovation.agilepm.domain.model.product.impl`

更好的办法参考下文的“依赖倒置原则”，调整一下分层架构中各层的顺序。



### 依赖倒置原则

